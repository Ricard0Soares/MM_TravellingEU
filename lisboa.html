<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" href="lisboa.css">
    <link rel="stylesheet" type="text/css" href="navBar.css">

    <style>
        #thumbnails{
            display:flex;
            flex-wrap: wrap;
        }

        .thumbnail{
            margin: 5px;
            cursor: pointer;
        }
    </style>

</head>

<body>
    <nav class="navbar">
        <div class="logo"><a href="home.html">TravellingEU</a></div>
        <ul class="nav-links">
            <li><a href="screens/navLinks/destinations.html">Destinations</a></li>
            <li><a href="screens/videos/videos.html">Videos</a></li>
            <li><a href="screens/navLinks/howitworks.html">How it works</a></li>
            <li><a href="screens/navLinks/aboutus.html">About Us</a></li>
        </ul>
    </nav>

    <div class="ellipse-container">
        <p>Lisboa</p>
        <div class="image-container">
            <img src="images/lisboa.png" alt="lisboa">
            <span>Lisboa é a capital e maior cidade de Portugal, com uma população estimada 
                de 548.703 habitantes em 2022 dentro dos seus limites administrativos numa 
                área de cerca de 100 quilómetros quadrados.</span>
        </div>
    </div>

    <div class="second-ellipse-container">
        <div class="video-container">
            <video id="myVideo" controls muted>
                <source src="teste.mp4" type="video/mp4">
            </video>
            <div id="overlay" class="overlay">
                <a href="home.html" id="link1" style="top: 10%; left: 10%;">Learn more about Lisbon</a>
                <a href="paris.html" id="link2" style="top: 20%; left: 20%;">Learn more about Paris</a>
            </div>
            <div id="thumbnails" class="thumbnails">
                
            </div>
        </div>
    </div>

    <div class="third-ellipse-container">
        <div class="photos-container">
            <img src="images/image_3.png" alt="cidade1">
        </div>
        <div class="photos-container">
            <img src="images/image_4.png" alt="cidade2">
        </div>
        <div class="photos-container">
            <img src="images/image_5.png" alt="cidade3">
        </div>
        <div class="photos-container">
            <img src="images/image_3.png" alt="cidade5">
        </div>
        <div class="photos-container">
            <img src="images/image_4.png" alt="cidade6">
        </div>
    </div>
    
    
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            var overlay = document.getElementById('overlay');


            
            const video = document.getElementById("myVideo");
            const thumbnailsContainer = document.getElementById("thumbnails");
            const canvas = document.createElement("canvas"); //para capturar frames e converter para thumbnails
            const ctx = canvas.getContext("2d");
            const thumbnailWidth = 160;
            const thumbnailHeight = 90;
            video.currentTime = 0;

            detectChanges();

            // Function to generate a thumbnail
            function generateThumbnail(time, callback) {
                video.currentTime = time;
                video.addEventListener('seeked', function captureFrame() {
                    ctx.drawImage(video, 0, 0, thumbnailWidth, thumbnailHeight); //gerar thumbnail
                    const dataURL = canvas.toDataURL();
                    callback(dataURL, time);
                    video.removeEventListener('seeked', captureFrame);
                });
            }

            // Function to detect significant changes in frames
            function detectChanges() {
                let lastImageData = null;
                const interval = 10; // seconds

                video.addEventListener('loadeddata', () => {
                    const duration = video.duration;
                    for (let t = 0; t < duration; t += interval) {
                        generateThumbnail(t, (dataURL, time) => {
                            const img = new Image();
                            img.src = dataURL;
                            img.width = thumbnailWidth;
                            img.height = thumbnailHeight;
                            img.classList.add("thumbnail");

                            img.addEventListener("click", () => {
                                video.currentTime = time;
                                video.play();
                            });

                            if (!lastImageData) {
                                thumbnailsContainer.appendChild(img);
                                console.log("added first");
                                console.log(img);
                                lastImageData = ctx.getImageData(0, 0, thumbnailWidth, thumbnailHeight);
                                
                            } else {
                                const currentImageData = ctx.getImageData(0, 0, thumbnailWidth, thumbnailHeight);
                                if (hasSignificantChange(lastImageData.data, currentImageData.data)) {
                                    thumbnailsContainer.appendChild(img);
                                    lastImageData = currentImageData;
                                }
                                console.log("added 2nd");
                                console.log(img);
                            }

                            console.log("t -> " + thumbnailsContainer);
                        });
                    }
                });
            }

            // Function to compare two frames
            function hasSignificantChange(data1, data2) {
                let changedPixels = 0;
                const threshold = 25; // change threshold per pixel
                const maxChangedPixels = 0.02 * data1.length / 4; // 2% of the pixels

                for (let i = 0; i < data1.length; i += 4) {
                    const diff = Math.abs(data1[i] - data2[i])
                    + Math.abs(data1[i + 1] - data2[i + 1])
                    + Math.abs(data1[i + 2] - data2[i + 2]);

                    if (diff > threshold) {
                    changedPixels++;
                    }
                }

                return changedPixels > maxChangedPixels;
            }

            

            video.addEventListener('timeupdate', function() {  
                var currentTime = video.currentTime;

                //links em intervalos de tempo especificos
                if (currentTime >= 5 && currentTime < 10) {
                    document.getElementById('link1').style.display = 'block';
                    document.getElementById('link2').style.display = 'none';
                    overlay.style.display = 'block';
                } else if (currentTime >= 10 && currentTime < 15) {
                    document.getElementById('link1').style.display = 'none';
                    document.getElementById('link2').style.display = 'block';
                    overlay.style.display = 'block';
                } else {
                    overlay.style.display = 'none';
                }
            });
        });
    </script>

</body>
</html>
